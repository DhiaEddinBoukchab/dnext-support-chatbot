From: Cornette Etienne <e.cornette@saftco.ch>
To: Saber Khalfallah
Date: 2025-10-03 11:00:39.742000+00:00
Subject: RE: Problème pour DL freight database
Message-ID: 711bab8049c245f5a7c710e50d1f9254@saftco.ch
In-Reply-To: ZR3P278MB1323FD93A42F23A87D6A7493F81AA@ZR3P278MB1323.CHEP278.PROD.OUTLOOK.COM

================================================================================

Bonjour Saber,

 

Merci pour ta prompte réponse. Le script est bon. 

 

Cependant, pour des raisons inconnues, le script tourne depuis 15 min et je n’ai aucun résultat.

 



 

Chokrane bzef,

 

Etienne

 

From: Saber Khalfallah <saber.khalfallah@dnext.io> 
Sent: Tuesday, September 30, 2025 12:27 PM
To: Cornette Etienne <e.cornette@saftco.ch>
Cc: Support Dnext <support@dnext.io>
Subject: RE: Problème pour DL freight database

 

*************************************Mail_Externe*********************************

* Soyez prudent lorsque vous ouvrez des liens, des pièces jointes et lorsque vous êtes invité à entrer des mots de passe ou des informations confidentielles. Signalez tout e-mail suspect à l'équipe service desk ou transmettez-le à l’adresse : itsecurity@ocpgroup.ma <mailto:itsecurity@ocpgroup.ma> .

* Be careful when opening links, attachments, and when prompted to enter passwords or confidential information. Report any suspicious emails to the service desk team or forward them to: itsecurity@ocpgroup.ma <mailto:itsecurity@ocpgroup.ma> .

******************************************************************************************

Bonjour Etienne,

 

J’espére que vous allez bien.

Je reviens vers vous concernant le script corrigé que je vous ai transmis hier.

 

Avez-vous pu le tester de votre côté et est-ce que tout fonctionne désormais correctement pour le téléchargement de la dataset freight ?

 

N’hésitez pas à me dire si vous rencontrez encore des soucis, je reste disponible pour vous aider.

 

Cordialement,

Saber Khalfallah

Customer Support

                                                                                                     saber.khalfallah@dnext.io <mailto:saber.khalfallah@dnext.io> 



 

 

DNEXT INTELLIGENCE SA | Avenue Louis-Casaï 81 | CH-1216 Cointrin

info@dnext.io <mailto:info@dnext.io>  | www.dnext.io <http://www.dnext.io/> 

 

 

From: Saber Khalfallah <saber.khalfallah@dnext.io <mailto:saber.khalfallah@dnext.io> > 
Sent: Monday, September 29, 2025 13:29
To: Etienne Cornette <e.cornette@saftco.ch <mailto:e.cornette@saftco.ch> >
Cc: Support Dnext <support@dnext.io <mailto:support@dnext.io> >
Subject: RE: Problème pour DL freight database

 

Bonjour Etienne


il y’avait quelques fautes des syntax que j’ai corrigé et j’ai testé le script , sa fonctionnait chez moi sans soucis .
vous trouverez ci-dessous le script corrigé :

Quote 
# Load required libraries 

library(httr) 

library(jsonlite)

library(readr)

 

# Function to login to API and get token 

connect <- function(email, pwd, env) { 

  # email: email used to connect to your dnext environment 

  # pwd: password 

  # env: name of your environment, first part in your dnext URL before the dot 

  # Example: ENV.dnext.io -> env = 'ENV' 

  

  # Construct the URL 

  url <- paste0(https://api.dnext.io/v1.0/auth/custom-login?org=, env) 

  

  # Create the payload 

  payload <- toJSON(list( 

    email = email, 

    password = pwd, 

    organization = env 

  ), auto_unbox = TRUE) 

  

  # Set the headers 

  headers <- add_headers('Content-Type' = 'application/json') 

  

  # Send the POST request 

  response <- POST(url, headers, body = payload) 

  

  # Parse the response and extract the token 

  token <- content(response)$token 

  return(token) 

} 

 

# Call the connect function with your credentials 

token <- connect(e.cornette@saftco.ch <mailto:e.cornette@saftco.ch> , "jgyH6564jijliuhçà_mkkjh", "saftco") 

token

 

get_task_status <- function(task_id, token) {

  my_headers <- add_headers(

    Authorization = paste("Bearer", token),

    `Content-Type` = "application/json"

  )

  

  success <- FALSE

  wait_time <- 2  # Initial wait time in seconds

  max_wait_time <- 120  # Maximum wait time in seconds (e.g., 2 minutes)

  

  while (!success && wait_time <= max_wait_time) {

    Sys.sleep(wait_time)  # Wait before checking status

    

    status_res <- GET(paste0('https://api.dnext.io/v1.0/tasks/', task_id), my_headers)

    status_text <- content(status_res, as = "text")

    print(paste("Task Status Response:", status_text))

    

    tryCatch({

      status_json <- fromJSON(status_text)

      print(paste("Task Status:", status_json$status))

      

      if (status_json$status == "SUCCEEDED") {

        success <- TRUE

      } else if (status_json$status == "FAILED") {

        print("Task failed.")

        break  # Exit the loop if the task has failed

      }

    }, error = function(e) {

      print(paste("Error parsing task status:", e$message))

    })

    

    if (!success) {

      wait_time <- wait_time * 2  # Exponential backoff

    }

  }

  

  return(success)

}

 

# Function to download dataset

download_dataset <- function(code, token) {

  my_headers <- add_headers(

    Authorization = paste("Bearer", token),

    `Content-Type` = "application/json"

  )

  

  dl_url <- paste0('https://api.dnext.io/v1.0/data/datasets/', code, '/download')

  res <- POST(dl_url, my_headers)

  

  # Debug: Print the raw API response

  print("Download request response:")

  print(content(res, as = "text"))

  

  res_json <- fromJSON(content(res, as = "text"))

  

  if (is.null(res_json$task$id)) {

    stop("Error: Task ID not found in the response.")

  }

  

  task_id <- res_json$task$id

  data_ready <- get_task_status(task_id, token)

  

  if (data_ready) {

    if (!is.null(res_json$result$url)) {

      data_url <- res_json$result$url

      data_resp <- GET(data_url)

      

      # Debug: Print response status code

      print(paste("Download response status code:", data_resp$status_code))

      

      if (data_resp$status_code == 200) {

        df <- read_csv(content(data_resp, as = "raw"), locale = locale(encoding = "UTF-8"), show_col_types = FALSE)

      } else {

        stop("Error: Failed to download dataset.")

      }

    } else {

      stop("Error: Data URL not found.")

    }

  } else {

    print("Task did not succeed. Returning NULL.")

    df <- NULL

  }

  

  return(df)

}

 

# Example usage

 

dataset_code <- "saftco-6a211b50-3b48-4e90-8f86-47e2e2b81909"  # Replace with your dataset code

df <- download_dataset(dataset_code, token)

 

# Debug: Print dataset preview if successful

if (!is.null(df)) {

  print("Dataset successfully downloaded:")

  print(head(df))

} else {

  print("No dataset returned.")

}

Unquote

Saber Khalfallah

Customer Support

                                                                                                     saber.khalfallah@dnext.io <mailto:saber.khalfallah@dnext.io> 



 

 

DNEXT INTELLIGENCE SA | Avenue Louis-Casaï 81 | CH-1216 Cointrin

info@dnext.io <mailto:info@dnext.io>  | www.dnext.io <http://www.dnext.io/> 

 

 

From: Saber Khalfallah <saber.khalfallah@dnext.io <mailto:saber.khalfallah@dnext.io> > 
Sent: Monday, September 29, 2025 13:12
To: Etienne Cornette <e.cornette@saftco.ch <mailto:e.cornette@saftco.ch> >
Cc: Support Dnext <support@dnext.io <mailto:support@dnext.io> >
Subject: RE: Problème pour DL freight database

 

Bonjour Etienne,

 

Merci pour votre message ! Je suis en train de vérifier ça tout de suite, je vous tiendrai au courant rapidement.

 

Cordialement

Saber Khalfallah

Customer Support

                                                                                                     saber.khalfallah@dnext.io <mailto:saber.khalfallah@dnext.io> 



 

 

DNEXT INTELLIGENCE SA | Avenue Louis-Casaï 81 | CH-1216 Cointrin

info@dnext.io <mailto:info@dnext.io>  | www.dnext.io <http://www.dnext.io/> 

 

 

From: Cornette Etienne <e.cornette@saftco.ch <mailto:e.cornette@saftco.ch> > 
Sent: Monday, September 29, 2025 12:46
To: Saber Khalfallah <saber.khalfallah@dnext.io <mailto:saber.khalfallah@dnext.io> >
Subject: Problème pour DL freight database

 

Bonjour Saber,

 

J’espère que tu vas bien. Je t’écris car je n’arrive pas à DL la databaase freight à partir de R.

 

Mon ordinateur mouline dans le vide et je n’arrive pas à récupérer le dataframe.

 

Peux tu m’aider stp ? 

 

 

Quote :

 

# Load required libraries 

library(httr) 

library(jsonlite)

library(readr)

 

# Function to login to API and get token 

connect <- function(email, pwd, env) { 

  # email: email used to connect to your dnext environment 

  # pwd: password 

  # env: name of your environment, first part in your dnext URL before the dot 

  # Example: ENV.dnext.io -> env = 'ENV' 

  

  # Construct the URL 

  url <- paste0(https://api.dnext.io/v1.0/auth/custom-login?org=, env) 

  

  # Create the payload 

  payload <- toJSON(list( 

    email = email, 

    password = pwd, 

    organization = env 

  ), auto_unbox = TRUE) 

  

  # Set the headers 

  headers <- add_headers('Content-Type' = 'application/json') 

  

  # Send the POST request 

  response <- POST(url, headers, body = payload) 

  

  # Parse the response and extract the token 

  token <- content(response)$token 

  return(token) 

} 

 

# Call the connect function with your credentials 

token <- connect(e.cornette@saftco.ch <mailto:e.cornette@saftco.ch> , "jgyH6564jijliuhçà_mkkjh", "saftco") 

token

 

get_task_status <- function(task_id, token) {

  my_headers <- add_headers(

    Authorization = paste("Bearer", token),

    `Content-Type` = "application/json"

  )

  

  success <- FALSE

  wait_time <- 2  # Initial wait time in seconds

  max_wait_time <- 120  # Maximum wait time in seconds (e.g., 2 minutes)

  

  while (!success && wait_time <= max_wait_time) {

    Sys.sleep(wait_time)  # Wait before checking status

    

    status_res <- GET(paste0('https://api.dnext.io/v1.0/tasks/', task_id), my_headers)

    status_text <- content(status_res, as = "text")

    print(paste("Task Status Response:", status_text))

    

    tryCatch({

      status_json <- fromJSON(status_text)

      print(paste("Task Status:", status_json$status))

      

      if (status_json$status == "SUCCEEDED") {

        success <- TRUE

      } else if (status_json$status == "FAILED") {

        print("Task failed.")

        break  # Exit the loop if the task has failed

      }

    }, error = function(e) {

      print(paste("Error parsing task status:", e$message))

    })

    

    if (!success) {

      wait_time <- wait_time * 2  # Exponential backoff

    }

  }

  

  return(success)

}

 

# Function to download dataset

download_dataset <- function(code, token) {

  my_headers <- add_headers(

    Authorization = paste("Bearer", token),

    `Content-Type` = "application/json"

  )

  

  dl_url <- paste0('https://api.dnext.io/v1.0/data/datasets/', code, '/download')

  res <- POST(dl_url, my_headers)

  

  # Debug: Print the raw API response

  print("Download request response:")

  print(content(res, as = "text"))

  

  res_json <- fromJSON(content(res, as = "text"))

  

  if (is.null(res_json$task$id)) {

    stop("Error: Task ID not found in the response.")

  }

  

  task_id <- res_json$task$id

  data_ready <- get_task_status(task_id, token)

  

  if (data_ready) {

    if (!is.null(res_json$result$url)) {

      data_url <- res_json$result$url

      data_resp <- GET(data_url)

      

      # Debug: Print response status code

      print(paste("Download response status code:", data_resp$status_code))

      

      if (data_resp$status_code == 200) {

        df <- read_csv(content(data_resp, as = "raw"), locale = locale(encoding = "UTF-8"), show_col_types = FALSE)

      } else {

        stop("Error: Failed to download dataset.")

      }

    } else {

      stop("Error: Data URL not found.")

    }

  } else {

    print("Task did not succeed. Returning NULL.")

    df <- NULL

  }

  

  return(df)

}

 

# Example usage

 

dataset_code <- "saftco-6a211b50-3b48-4e90-8f86-47e2e2b81909"  # Replace with your dataset code

df <- download_dataset(dataset_code, token)

 

# Debug: Print dataset preview if successful

if (!is.null(df)) {

  print("Dataset successfully downloaded:")

  print(head(df))

} else {

  print("No dataset returned.")

}

 

Best regards,

 

Etienne Cornette

Grains Trader

==============

SAFTCO SA 

Rue du Mont-Blanc 3,

1201 GENEVA – CH



 

------------------------------DISCLAIMER------------------------------------

-Les informations contenues dans ce document sont de nature confidentielle et à l'usage exclusif des destinataires prévus.Si vous l'avez reçu par erreur, son utilisation sous quelque forme qu'elle soit est strictement interdite. Nous vous remercions dans ce cas de détruire le message et de prendre contact avec son expéditeur. L'intégrité des messages n'étant pas assurée sur Internet, le Groupe OCP ne saurait être tenu responsable si ce message s'avérait modifié ou falsifié.

-The information contained in this message and any attachments hereto are confidential and intended solely for the addressee(s) intended. If you are not the intended addressee of this message, you are hereby notified thatyou have received this document in error. Any review, dissemination, distribution, or copying of this message is prohibited. Please delete it and inform the sender immediately. Thank you for your help. Messages are susceptible to alteration. OCP GROUP shall not be liable for the message if altered,changed or falsified.

 

------------------------------DISCLAIMER------------------------------------

-Les informations contenues dans ce document sont de nature confidentielle et à l'usage exclusif des destinataires prévus.Si vous l'avez reçu par erreur, son utilisation sous quelque forme qu'elle soit est strictement interdite. Nous vous remercions dans ce cas de détruire le message et de prendre contact avec son expéditeur. L'intégrité des messages n'étant pas assurée sur Internet, le Groupe OCP ne saurait être tenu responsable si ce message s'avérait modifié ou falsifié.

-The information contained in this message and any attachments hereto are confidential and intended solely for the addressee(s) intended. If you are not the intended addressee of this message, you are hereby notified thatyou have received this document in error. Any review, dissemination, distribution, or copying of this message is prohibited. Please delete it and inform the sender immediately. Thank you for your help. Messages are susceptible to alteration. OCP GROUP shall not be liable for the message if altered,changed or falsified.
